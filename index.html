const tg = window.Telegram?.WebApp;
const $ = (q) => document.querySelector(q);
const $$ = (q) => Array.from(document.querySelectorAll(q));

function safeSet(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value;
}

const state = {
  tab: "home",
  user: { id: "local", name: "User" },
  progress: JSON.parse(localStorage.getItem("mr_progress") || "{}"),
};

function saveProgress() {
  localStorage.setItem("mr_progress", JSON.stringify(state.progress));
}
function setProgress(key, value) {
  state.progress[key] = value;
  saveProgress();
}

// ===== DATA (MVP) =====
const academy = {
  courses: [
    {
      id: "wash",
      title: "Курс мойки",
      desc: "Обязательная база. Откроет доступ к платным курсам.",
      free: true,
      modules: [
        {
          id: "wash_m1",
          title: "Модуль 1 — Основы",
          lessons: [
            {
              id: "wash_l1",
              title: "Что такое детейлинг",
              text: `Детейлинг — это системный уход: очистка + восстановление + защита.`,
              test: {
                q: "Детейлинг — это…",
                options: [
                  "Просто мойка",
                  "Системный уход: очистка + восстановление + защита",
                  "Только полировка",
                ],
                correct: 2,
                explain: "Детейлинг включает очистку, восстановление и защиту.",
              },
            },
            {
              id: "wash_l2",
              title: "Ошибки новичков",
              text: `Топ ошибок: одна губка на всё, мойка по сухой пыли, сильная химия без контроля.`,
              test: {
                q: "Что чаще всего даёт микроцарапины?",
                options: [
                  "Одна губка/тряпка на всё",
                  "Раздельные ведра и микрофибры",
                  "Сушка воздухом",
                ],
                correct: 1,
                explain: "Одна губка собирает абразив и царапает ЛКП.",
              },
            },
          ],
        },
        {
          id: "wash_m2",
          title: "Модуль 2 — Процесс",
          lessons: [
            {
              id: "wash_l3",
              title: "Двухфазная мойка",
              text: `Фаза 1 снимает основную грязь, фаза 2 безопасно домывает. Контакт — только после бесконтакта.`,
              test: {
                q: "Зачем нужна первая фаза?",
                options: [
                  "Чтобы снять грязь и снизить риск царапин",
                  "Чтобы высушить кузов",
                  "Чтобы быстрее перейти к контакту",
                ],
                correct: 1,
                explain: "Фаза 1 снимает грязь, снижая абразив при контакте.",
              },
            },
          ],
        },
      ],
    },
    {
      id: "interior",
      title: "Химчистка салона",
      desc: "Покупка/подписка. –50% за 3 друзей.",
      free: false,
      modules: [
        {
          id: "int_m1",_
